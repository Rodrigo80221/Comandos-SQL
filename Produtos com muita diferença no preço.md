``` sql

DECLARE @DataVersao as datetime
DECLARE @DIFERENCA AS FLOAT 

set @DataVersao = '2022-07-14 11:00:00'
SET @DIFERENCA = 20

SELECT T1.codLoja , T1.codProduto,T1.ValorNoPdv, T2.VALOR_ALTERADO [ÚLT. ALTERAÇÃO DE PREÇO], T2.DATA_ALTERACAO , (SELECT CD_ASSOCIADO FROM PRODUTOS WHERE CODIGO = T1.codProduto) CD_ASSOCIADO  FROM 
(
	SELECT PL.codLoja,PL.codProduto,PL.ValorNoPdv FROM ProdutoLojas PL
	WHERE PL.codProduto in (SELECT CODIGO FROM PRODUTOS WHERE SUBSTRING(CONFIG,1,1) = '1') AND PL.ValorNoPdv <> 0
) T1
INNER JOIN 
(

	SELECT PA1.CODLOJA, PA1.CD_PRODUTO , PA1.DATA_ALTERACAO , PA1.VALOR_ALTERADO  FROM PRECOS_ALTERADOS PA1 INNER JOIN
	(
	select PA.CODLOJA, PA.CD_PRODUTO , MAX(PA.DATA_ALTERACAO) DATA_ALTERACAO
	from PRECOS_ALTERADOS PA where 1 = 1
	AND DATA_ALTERACAO >= @DataVersao 
	AND DATA_ALTERACAO IS NOT NULL
	AND cd_produto in (SELECT CODIGO FROM PRODUTOS WHERE SUBSTRING(CONFIG,1,1) = '1')
	GROUP BY  PA.CODLOJA, PA.CD_PRODUTO
	) AS PA2 ON PA1.CODLOJA = PA2.CODLOJA AND PA1.CD_PRODUTO = PA2.CD_PRODUTO AND PA1.DATA_ALTERACAO = PA2.DATA_ALTERACAO 



) T2 ON T1.codLoja = T2.CODLOJA AND T1.codProduto = T2.CD_PRODUTO 

WHERE ABS(T1.ValorNoPdv - T2.VALOR_ALTERADO ) > (T1.ValorNoPdv * (@DIFERENCA/100))

ORDER BY T1.CODLOJA ASC, ABS(T1.ValorNoPdv - T2.VALOR_ALTERADO )  DESC


``` 
