
``` sql

-- SCRIPT PARA INSERIR O PACK PROMOCIONAL -- CARTÃO SENF DA REDE SUPER -- (PACK VIRTUAL PREÇO 2) 

SET NOCOUNT ON

-- PARÂMETROS O PACK VIRTUAL------------------------------------------------------------------------------------------------------------

-- DATA DE VIGÊNCIA 
DECLARE @DATA_INICIO NVARCHAR(20) = Convert(SmallDateTime, '20230526', 126)
DECLARE @DATA_FIM NVARCHAR(20) = Convert(SmallDateTime, '20230603', 126)

-- DESCRIÇÃO 
DECLARE @DESCRICAO NVARCHAR(1024) = 'Cartão Rede Maio/Junho de 2023'

-- PRODUTOS DO PACK VIRTUAL (CÓDIGO DE BARRAS + VALOR PROMOCIONAL PREÇO 2)

DECLARE @Produto_e_VlrPromocao AS TABLE (BARRAS NVARCHAR(30), PRECO2 MONEY)

INSERT INTO @Produto_e_VlrPromocao SELECT '7896724501564',18.9
INSERT INTO @Produto_e_VlrPromocao SELECT '7896724501083',18.9
INSERT INTO @Produto_e_VlrPromocao SELECT '7896053410391',5.99
INSERT INTO @Produto_e_VlrPromocao SELECT '7896053410384',5.99
INSERT INTO @Produto_e_VlrPromocao SELECT '7896053410100',5.99
INSERT INTO @Produto_e_VlrPromocao SELECT '7898080640239',0.99
INSERT INTO @Produto_e_VlrPromocao SELECT '7896691100210',3.99
INSERT INTO @Produto_e_VlrPromocao SELECT '7622210571755',0.88
INSERT INTO @Produto_e_VlrPromocao SELECT '7622210571601',0.88
INSERT INTO @Produto_e_VlrPromocao SELECT '7622210571786',0.88
INSERT INTO @Produto_e_VlrPromocao SELECT '7896022201944',0.99
INSERT INTO @Produto_e_VlrPromocao SELECT '7896022201869',0.99
INSERT INTO @Produto_e_VlrPromocao SELECT '7896022201852',0.99
INSERT INTO @Produto_e_VlrPromocao SELECT '7896022203146',0.99
INSERT INTO @Produto_e_VlrPromocao SELECT '7896022203849',0.99
INSERT INTO @Produto_e_VlrPromocao SELECT '7896022203122',0.99
INSERT INTO @Produto_e_VlrPromocao SELECT '7896022203139',0.99
INSERT INTO @Produto_e_VlrPromocao SELECT '7896022201906',0.99
INSERT INTO @Produto_e_VlrPromocao SELECT '7896022201890',0.99
INSERT INTO @Produto_e_VlrPromocao SELECT '7896022201913',0.99
INSERT INTO @Produto_e_VlrPromocao SELECT '7896022201937',0.99
INSERT INTO @Produto_e_VlrPromocao SELECT '7896022202101',0.99
INSERT INTO @Produto_e_VlrPromocao SELECT '7896577203318',3.29
INSERT INTO @Produto_e_VlrPromocao SELECT '7896577210101',3.29
INSERT INTO @Produto_e_VlrPromocao SELECT '7896577203301',3.29
INSERT INTO @Produto_e_VlrPromocao SELECT '7896577203370',3.29
INSERT INTO @Produto_e_VlrPromocao SELECT '7896577203288',3.29
INSERT INTO @Produto_e_VlrPromocao SELECT '7896577203271',3.29
INSERT INTO @Produto_e_VlrPromocao SELECT '7896577210125',3.29
INSERT INTO @Produto_e_VlrPromocao SELECT '7896577203325',3.29
INSERT INTO @Produto_e_VlrPromocao SELECT '7896577203264',3.29
INSERT INTO @Produto_e_VlrPromocao SELECT '7896577210118',3.29
INSERT INTO @Produto_e_VlrPromocao SELECT '7896577203257',3.29


-- PARÂMETROS O PACK VIRTUAL------------------------------------------------------------------------------------------------------------


DECLARE @PRECO_PROMOCIONAL AS MONEY

DECLARE PACKVIRTUAL CURSOR LOCAL   
FOR SELECT DISTINCT PRECO2 FROM @Produto_e_VlrPromocao   
OPEN PACKVIRTUAL;   
FETCH NEXT FROM PACKVIRTUAL INTO @PRECO_PROMOCIONAL;   
WHILE @@FETCH_STATUS = 0   
BEGIN

							-- DESCRIÇÃO DO PACK
							--DECLARE @TITULOPACK NVARCHAR(1024) = 'Oferta Cartão Rede Super Maio/Junho de 2023 (R$ ' + rtrim(ltrim(str(@PRECO_PROMOCIONAL,10,2))) + ')'
							DECLARE @TITULOPACK NVARCHAR(1024) = @DESCRICAO + ' (R$ ' + CONVERT(NVARCHAR,@PRECO_PROMOCIONAL) + ')'

							-- BUSCA O CÓDIGO DO PACK
							DECLARE @CODPACK BIGINT = (SELECT MAX(CODIGO) + 1 FROM PACKVIRTUAL)
							
							-- TRATAMENTO PARA EVITAR DUPLICIDADE
							IF (SELECT COUNT(CODIGO) FROM PackVirtual WHERE DESCRICAO = @TITULOPACK AND DtFinal > GETDATE()) > 0
							BEGIN
								PRINT 'JÁ FOI CADASTRADO UM PACK COM A DESCRIÇÃO ' + @TITULOPACK
								FETCH NEXT FROM PACKVIRTUAL INTO @PRECO_PROMOCIONAL;   
								CONTINUE;
							END 

							INSERT INTO PACKVIRTUAL (Codigo,Descricao,DtInicial,DtFinal,ModeloPack,QtdRegra,VlrRegra,EnviouPreco2,CodEncarte,ValidoClienteNaoIdent,TipoAjusteValor,AjusteUltimaCasaDecimal,QuantidadeLimite,CodScannTech)
							SELECT @CODPACK , @TITULOPACK , @DATA_INICIO , @DATA_FIM, 4,1,@PRECO_PROMOCIONAL,0,1,1,'',0,0,0

							PRINT 'PROMOÇÃO PACK INSERIDA (' + CONVERT(NVARCHAR,@CODPACK) + ': ' + @TITULOPACK + ')' 
						
							-- DEFINE O PACK PARA TODAS AS LOJAS

								DECLARE @CODLOJA AS INTEGER

								DECLARE NOVOS CURSOR LOCAL   
								FOR SELECT CODIGO FROM LOJAS   
								OPEN NOVOS;   
								FETCH NEXT FROM NOVOS INTO @CODLOJA;   
								WHILE @@FETCH_STATUS = 0   
									BEGIN   
										INSERT INTO PackVirtualLojas SELECT @CODPACK, @CODLOJA 
										FETCH NEXT FROM NOVOS INTO @CODLOJA;   
									END   
								CLOSE NOVOS;   
								DEALLOCATE NOVOS;   


	
							-- DEFINE O PACK PARA TODOS OS GRUPOS DE CLIENTES  (FOI UTILIZADO CURSOR DEVIDO A TRIGGER)

								DECLARE @COD_GRUPO_CLIENTE AS INTEGER
								DECLARE NOVOS CURSOR LOCAL   
								FOR SELECT CODIGO FROM GRUPOS_CLIENTES   
								OPEN NOVOS;   
								FETCH NEXT FROM NOVOS INTO @COD_GRUPO_CLIENTE;   
								WHILE @@FETCH_STATUS = 0   
									BEGIN   
										INSERT INTO PackVirtualGrupoClientes SELECT @CODPACK, @COD_GRUPO_CLIENTE 
										FETCH NEXT FROM NOVOS INTO @COD_GRUPO_CLIENTE;   
									END   
								CLOSE NOVOS;   
								DEALLOCATE NOVOS;  


							-- DEFINE O PACK PARA TODAS FORMAS DE PAGAMENTO DO TIPO CARTÃO  (FOI UTILIZADO CURSOR DEVIDO A TRIGGER) 

								DECLARE @COD_FORMA_PGTO AS INTEGER
								DECLARE NOVOS CURSOR LOCAL   
								FOR  SELECT codigo FROM Formas_Pgto WHERE config = '310'   
								OPEN NOVOS;   
								FETCH NEXT FROM NOVOS INTO @COD_FORMA_PGTO;   
								WHILE @@FETCH_STATUS = 0   
									BEGIN   
										INSERT INTO PackVirtualFormasPgto SELECT @CODPACK, @COD_FORMA_PGTO 
										FETCH NEXT FROM NOVOS INTO @COD_FORMA_PGTO;   
									END   
								CLOSE NOVOS;   
								DEALLOCATE NOVOS;  

							-- INSERE AS INFORMAÇÕES DE BINS DO CARTÃO
							INSERT INTO PackVirtualFormasPgtoTEF SELECT @CODPACK, 1,'Cartão Rede Super Crédito'
							INSERT INTO PackVirtualFormasPgtoTEFBins SELECT @CODPACK, 1, '603409'

							-- INSERE OS PRODUTOS 

								DECLARE @BARRAS AS NVARCHAR(30)
								DECLARE @PRECO2 MONEY
								DECLARE @COD_PRODUTO FLOAT

								DECLARE NOVOS CURSOR LOCAL   
								FOR  SELECT BARRAS, PRECO2 FROM @Produto_e_VlrPromocao WHERE PRECO2 = @PRECO_PROMOCIONAL
								OPEN NOVOS;   
								FETCH NEXT FROM NOVOS INTO @BARRAS, @PRECO2;   
								WHILE @@FETCH_STATUS = 0   
									BEGIN   
										SET @COD_PRODUTO = (select top 1 CD_PRODUTO from PRODUTO_BARRAS WHERE BARRAS = @BARRAS ORDER BY CD_PRODUTO DESC )

										IF (@COD_PRODUTO IS NOT NULL)
										BEGIN 
										   INSERT INTO PackVirtualGrupo1 SELECT @CODPACK, @COD_PRODUTO
										   PRINT 'PACK : ' + CONVERT(NVARCHAR,@CODPACK) + ' - INSERIDO PRODUTO ' +  CONVERT(NVARCHAR,@COD_PRODUTO)  
										END
										ELSE
										BEGIN
											PRINT 'ERRO PACK : ' + CONVERT(NVARCHAR,@CODPACK) + ' - NÃO FOI ENCONTRADO UM PRODUTO PARA O CÓDIGO DE BARRAS: ' +  @BARRAS
										END
 
										FETCH NEXT FROM NOVOS INTO  @BARRAS, @PRECO2;   
									END   
								CLOSE NOVOS;   
								DEALLOCATE NOVOS; 


		FETCH NEXT FROM PACKVIRTUAL INTO @PRECO_PROMOCIONAL;   
END   
CLOSE PACKVIRTUAL;   
DEALLOCATE PACKVIRTUAL;   


```
